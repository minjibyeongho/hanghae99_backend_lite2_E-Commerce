# 동시성 이슈 분석

## 1. 개요

- 현재 구성한 프로젝트 내에 동시성 이슈가 발생할 수 있는 부분을 찾아서 작성
- 각 이슈별 해결 방안을 제시 및 구현 적용
- 학습 중인 3가지 동시성 제어 방식 적용(권장)

## 2. 동시성 제어 방법(조사)

| 구분             | 비관적 락                      | 조건부 업데이트           | 낙관적 락 + 재시도                          |
| ---------------- | ------------------------------ | ------------------------- | ------------------------------------------- |
| 락 방식          | DB 레벨 락 (SELECT FOR UPDATE) | 락 없음 (원자적 연산)     | 애플리케이션 레벨 버전 체크                 |
| 충돌 방지 시점   | 읽기 시점 (사전 차단)          | 쓰기 시점 (조건 검증)     | 커밋 시점 (사후 감지)                       |
| 동시성 제어      | ⭐⭐⭐⭐⭐100% 보장            | ⭐⭐⭐⭐⭐100% 보장       | ⭐⭐⭐⭐재시도로 보장 (극단 상황 실패 가능) |
| 성능 (처리량)    | ⭐⭐⭐Lock Wait로 제한         | ⭐⭐⭐⭐⭐최고 성능       | ⭐⭐⭐⭐충돌 시 재시도 오버헤드             |
| 응답 시간        | ⭐⭐대기 시간 발생             | ⭐⭐⭐⭐⭐즉시 성공/실패  | ⭐⭐⭐재시도 시 지연                        |
| 구현 복잡도      | ⭐⭐⭐⭐⭐매우 간단            | ⭐⭐⭐⭐조건 단순 시 쉬움 | ⭐⭐재시도 로직 복잡                        |
| 데드락 위험      | ⭐⭐주의 필요                  | ⭐⭐⭐⭐⭐없음            | ⭐⭐⭐⭐⭐없음                              |
| 확장성           | ⭐⭐⭐DB 병목 가능             | ⭐⭐⭐⭐스케일아웃 용이   | ⭐⭐⭐⭐⭐수평 확장 유리                    |
| 적합한 충돌 빈도 | 높음                           | 중간                      | 낮음                                        |

## 3. 이슈사항 도출

### 1. Inventory

- 여러 사용자가 동시에 한 상품에 접근 및 구매 시 초과판매(Oversell)가 발생 할 수 있습니다.
  - 재고가 음수 또는 불일치

### 2. Wallet

- 동일 사용자가 2건 이상의 상품을 주문하고 꼬일 경우 잔액이 음수가 될 수 있습니다.( 또는 네트워크 지연으로 인해 2번 차감 )
- 충전, 결제가 동시 발생 시 1개의 변경사항이 적용이 되지 않을 수 있습니다.

### 3. Coupon

- 동시에 사용자가 몰려 100명의 사용자가 동시간에 쿠폰을 조회하고 발급 시에 초과 발급이 발생 할 수 있습니다.
- 한 사용자가 2번 요청 시 중복 발급이 발생할 수 있습니다.

## 4. 해결방안

### 1. Inventory

- 재고의 경우 정합성이 중요하고, 결제(금액)에 연관된 자원으로 비관적 락을 적용하여 구현 및 테스트

### 2. Wallet

- 조건부 업데이트 방식을 채택, 사용자별 지갑이 따로 있어 충돌 가능성이 적고 비관적 락보다는 빠른 성능과 구체적인 조건이 존재
- 구체적 조건이라 함은 잔액보다 결제액이 높을 수가 없음( balance < quantity )
- 추가로 멱등성 키(Idempotency)를 활용하여 중복 결제를 차단

### 3. Coupon

- 낙관적 락 적용, 순차 쿠폰의 경우 사용자가 다수 접근하고 조회하는 경우로 동시에 몰리고 빠른 처리가 필요할 것으로 예상됨
- 재시도 로직 구현, 경험적인 부분으로 쿠폰 발급 시 재시도 해본 경험이 있어 최적의 방법이 아닌가 싶음
- @Version 필드 활용 구현
- coupon_id와 user_id를 활용 중복 발급 체크
